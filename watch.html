<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch - BentoRoll</title>
<link rel="stylesheet" href="/src/styles/reset.css">
<link rel="stylesheet" href="/src/styles/header.css">
<link rel="stylesheet" href="/src/styles/hero.css">
<link rel="stylesheet" href="/src/styles/cards.css">
<link rel="stylesheet" href="/src/styles/episodes.css">
<link rel="stylesheet" href="/src/styles/pages.css">
<link rel="stylesheet" href="/src/styles/watch.css">
<link rel="stylesheet" href="/src/styles/labels.css">
<link rel="stylesheet" href="/src/styles/responsive.css">
<link rel="stylesheet" href="/src/styles/navbar.css">
<link rel="icon" type="image/x-icon" href="https://i.ibb.co/pjJPbymj/image.png">
<style>
.video-fade-out { opacity: 0; transition: opacity 0.3s ease; }
.version-button { padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 14px; border: none; cursor: pointer; margin-right: 8px; color: #fff; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.2s, box-shadow 0.2s; }
.version-button:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 15px rgba(0,0,0,0.25); }
.version-button:active { transform: translateY(0) scale(0.98); box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
.version-button.en { background-color: #f60; }
.version-button.ja { background-color: #007aff; }
.version-button.ko { background-color: #28a745; }
.version-button.active { box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
#provider-links { margin-top: 12px; }
</style>
</head>
<body>
<header>
    <div id="logo-container">
        <img id="logo-img" src="https://i.ibb.co/pjJPbymj/image.png" alt="BentoRoll Logo">
        <h1 id="logo-text">BentoRoll</h1>
    </div>
    <nav><a href="index.html">Home</a></nav>
</header>

<main class="watch-page">
    <div class="watch-container">
        <video id="introVideo" autoplay playsinline class="video-player">
            <source src="https://github.com/Vystelior/bentoroll.github.io/raw/refs/heads/main/src/intro.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <iframe id="player" class="video-player" frameborder="0" allowfullscreen style="display:none;"></iframe>
    </div>

    <section class="episode-details">
        <h2 id="episode-title" class="watch-title">Loading...</h2>
        <p id="episode-description" class="episode-description-preview"></p>
        <div class="episode-version-buttons" id="version-buttons"></div>
        <div class="episode-version-buttons" id="provider-links"></div>
        <div class="episode-nav-buttons">
            <button id="prev-btn" class="nav-button prev-button" disabled>&larr; Previous</button>
            <button id="next-btn" class="nav-button next-button" disabled>Next &rarr;</button>
        </div>
    </section>
</main>

<footer><p>&copy; 2025 BentoRoll. All rights not reserved.</p></footer>

<script>
const params = new URLSearchParams(window.location.search);
const epNum = parseInt(params.get('episode'));
const seriesSlug = params.get('series') || 'gachiakuta';
const malIdFromQuery = params.get('mal');
const seasonNum = parseInt(params.get('season')) || 1;
let version = params.get('version') || 'en';

const episodeTitle = document.getElementById('episode-title');
const episodeDesc = document.getElementById('episode-description');
const player = document.getElementById('player');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const versionButtons = document.getElementById('version-buttons');
const providerLinks = document.getElementById('provider-links');
const intro = document.getElementById('introVideo');

let resolvedMalId = malIdFromQuery || '';

const capitalize = s => typeof s === 'string' ? s.charAt(0).toUpperCase() + s.slice(1) : '';

const unslugify = (slug = '') => slug
    .replace(/-/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

const resolveMalId = async () => {
    if (malIdFromQuery) return malIdFromQuery;

    const searchTerms = [unslugify(seriesSlug)];
    try {
        const localRes = await fetch('data/series.json');
        if (localRes.ok) {
            const localSeries = await localRes.json();
            const localMatch = localSeries.find(item => item.slug === seriesSlug);
            if (localMatch?.title) searchTerms.unshift(localMatch.title);
        }
    } catch (err) {
        console.error('Failed to load local series index for MAL resolve:', err);
    }

    for (const term of searchTerms.filter(Boolean)) {
        try {
            const res = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(term)}&limit=1&sfw=true`);
            if (!res.ok) continue;
            const payload = await res.json();
            const candidate = payload?.data?.[0];
            if (candidate?.mal_id) return String(candidate.mal_id);
        } catch {
            // try next term
        }
    }

    return '';
};
const navigateToEpisode = (num, ver = version) => {
    const malQuery = resolvedMalId ? `&mal=${resolvedMalId}` : '';
    window.location.href = `watch.html?series=${seriesSlug}&season=${seasonNum}&episode=${num}&version=${ver}${malQuery}`;
};

const buildFallbackLinks = (title, epNumber) => {
    const query = encodeURIComponent(`${title} episode ${epNumber}`);
    return [
        { label: 'Crunchyroll Search', href: `https://www.crunchyroll.com/search?q=${query}` },
        { label: 'YouTube Search', href: `https://www.youtube.com/results?search_query=${query}` },
        { label: 'AniList', href: `https://anilist.co/search/anime?search=${encodeURIComponent(title)}` },
        { label: 'MyAnimeList', href: `https://myanimelist.net/anime.php?q=${encodeURIComponent(title)}` }
    ];
};

const fetchOfficialStreamingLinks = async () => {
    if (!resolvedMalId) return [];
    const res = await fetch(`https://api.jikan.moe/v4/anime/${resolvedMalId}/full`);
    if (!res.ok) return [];
    const payload = await res.json();
    const streaming = payload?.data?.streaming || [];
    return streaming
        .filter(item => item?.url && item?.name)
        .map(item => ({ label: item.name, href: item.url }));
};

const renderAlternativeLinks = async (title, epNumber) => {
    providerLinks.innerHTML = '<strong>Alternative watch links:</strong> ';
    const officialLinks = await fetchOfficialStreamingLinks().catch(() => []);
    const linksToShow = officialLinks.length ? officialLinks : buildFallbackLinks(title, epNumber);

    linksToShow.forEach(item => {
        const a = document.createElement('a');
        a.href = item.href;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = item.label;
        a.className = 'version-button en';
        a.style.textDecoration = 'none';
        a.style.display = 'inline-block';
        providerLinks.appendChild(a);
    });

    if (!officialLinks.length) {
        const hint = document.createElement('p');
        hint.textContent = 'Official provider list unavailable for this title, showing search links.';
        hint.style.marginTop = '8px';
        hint.style.fontSize = '0.9rem';
        hint.style.color = '#555';
        providerLinks.appendChild(hint);
    }
};

const showEpisode = (videoUrl) => {
    intro.classList.add('video-fade-out');
    setTimeout(() => {
        intro.remove();
        player.style.display = 'block';
        player.src = videoUrl;
        player.allow = 'autoplay; fullscreen';
    }, 300);
};

const loadLocalEpisodes = async () => {
    const res = await fetch(`data/${seriesSlug}/season${seasonNum}.json`);
    if (!res.ok) throw new Error('Local episodes not found');
    return res.json();
};

const loadJikanEpisode = async () => {
    if (!resolvedMalId) throw new Error('No MAL id available.');
    const [animeRes, epRes] = await Promise.all([
        fetch(`https://api.jikan.moe/v4/anime/${resolvedMalId}`),
        fetch(`https://api.jikan.moe/v4/anime/${resolvedMalId}/episodes/${epNum}`)
    ]);
    const anime = animeRes.ok ? (await animeRes.json()).data : null;
    const epData = epRes.ok ? (await epRes.json()).data : null;
    if (!epData) throw new Error('Episode not available from Jikan');
    return [{
        episode: epNum,
        title: epData.title || `Episode ${epNum}`,
        description: epData.synopsis || 'No description available.',
        videos: {},
        series: anime?.title || seriesSlug
    }];
};

Promise.resolve()
.then(async () => {
    resolvedMalId = await resolveMalId();
    return loadLocalEpisodes().catch(loadJikanEpisode);
})
.then(episodes => {
    episodes.sort((a,b) => a.episode - b.episode);
    const currentIndex = episodes.findIndex(e => e.episode === epNum);
    const ep = episodes[currentIndex];

    if (!ep) throw new Error('Episode not found');

    const candidates = [ep.videos?.[version], ep.videos?.ja, ep.videos?.en]
        .filter(Boolean)
        .filter(url => !url.includes('streamtape') && !url.includes('stape.fun'));
    const videoUrl = candidates[0] || '';

    const displaySeriesTitle = ep.series || capitalize(seriesSlug);
    episodeTitle.textContent = `${displaySeriesTitle} S${seasonNum}E${ep.episode}: ${ep.title}`;
    episodeDesc.textContent = ep.description || 'No description available.';
    document.title = `${displaySeriesTitle} S${seasonNum}E${ep.episode} | BentoRoll`;

    versionButtons.innerHTML = '';
    Object.keys(ep.videos || {}).forEach(lang => {
        const btn = document.createElement('button');
        btn.textContent = lang.toUpperCase();
        btn.className = `version-button ${lang}` + (lang === version ? ' active' : '');
        btn.onclick = () => navigateToEpisode(ep.episode, lang);
        versionButtons.appendChild(btn);
    });

    const prevEp = episodes[currentIndex - 1];
    const nextEp = episodes[currentIndex + 1];
    if (prevEp) {
        prevBtn.disabled = false;
        prevBtn.textContent = `← Ep ${prevEp.episode}`;
        prevBtn.onclick = () => navigateToEpisode(prevEp.episode, version);
    }
    if (nextEp) {
        nextBtn.disabled = false;
        nextBtn.textContent = `Ep ${nextEp.episode} →`;
        nextBtn.onclick = () => navigateToEpisode(nextEp.episode, version);
    }

    if (videoUrl) {
        intro.onended = () => showEpisode(videoUrl);
        intro.onclick = () => showEpisode(videoUrl);
    } else {
        intro.remove();
        player.style.display = 'block';
        player.srcdoc = '<p style="font-family:Arial;padding:2rem;text-align:center">No embedded stream is available right now. Use the alternative links below.</p>';
    }

    renderAlternativeLinks(displaySeriesTitle, ep.episode);
})
.catch(err => {
    console.error('Error loading:', err);
    episodeTitle.textContent = 'Failed to load episode data.';
});
</script>

<script src="/src/scripts/navbar.js"></script>
</body>
</html>
